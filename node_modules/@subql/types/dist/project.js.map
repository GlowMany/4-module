{"version":3,"file":"project.js","sourceRoot":"","sources":["../src/project.ts"],"names":[],"mappings":";AAAA,gEAAgE;AAChE,sCAAsC;;;AAMtC,IAAY,mBAEX;AAFD,WAAY,mBAAmB;IAC7B,oDAA6B,CAAA;AAC/B,CAAC,EAFW,mBAAmB,GAAnB,2BAAmB,KAAnB,2BAAmB,QAE9B;AAED,IAAY,gBAIX;AAJD,WAAY,gBAAgB;IAC1B,oDAAgC,CAAA;IAChC,kDAA8B,CAAA;IAC9B,oDAAgC,CAAA;AAClC,CAAC,EAJW,gBAAgB,GAAhB,wBAAgB,KAAhB,wBAAgB,QAI3B","sourcesContent":["// Copyright 2020-2021 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport {ApiPromise} from '@polkadot/api';\nimport {RegistryTypes} from '@polkadot/types/types';\nimport {SubstrateBlock, SubstrateEvent, SubstrateExtrinsic} from './interfaces';\n\nexport enum SubqlDatasourceKind {\n  Runtime = 'substrate/Runtime',\n}\n\nexport enum SubqlHandlerKind {\n  Block = 'substrate/BlockHandler',\n  Call = 'substrate/CallHandler',\n  Event = 'substrate/EventHandler',\n}\n\nexport type RuntimeHandlerInputMap = {\n  [SubqlHandlerKind.Block]: SubstrateBlock;\n  [SubqlHandlerKind.Event]: SubstrateEvent;\n  [SubqlHandlerKind.Call]: SubstrateExtrinsic;\n};\n\ntype RuntimeFilterMap = {\n  [SubqlHandlerKind.Block]: SubqlNetworkFilter;\n  [SubqlHandlerKind.Event]: SubqlEventFilter;\n  [SubqlHandlerKind.Call]: SubqlCallFilter;\n};\n\nexport interface ProjectManifest {\n  specVersion: string;\n  description: string;\n  repository: string;\n\n  schema: string;\n\n  network: {\n    endpoint: string;\n    customTypes?: RegistryTypes;\n  };\n\n  dataSources: SubqlDatasource[];\n}\n\n// [startSpecVersion?, endSpecVersion?] closed range\nexport type SpecVersionRange = [number, number];\n\ninterface SubqlBaseHandlerFilter {\n  specVersion?: SpecVersionRange;\n}\n\nexport type SubqlBlockFilter = SubqlBaseHandlerFilter;\n\nexport interface SubqlEventFilter extends SubqlBaseHandlerFilter {\n  module?: string;\n  method?: string;\n}\n\nexport interface SubqlCallFilter extends SubqlEventFilter {\n  success?: boolean;\n}\n\nexport interface SubqlBlockHandler {\n  handler: string;\n  kind: SubqlHandlerKind.Block;\n  filter?: SubqlBlockFilter;\n}\n\nexport interface SubqlCallHandler {\n  handler: string;\n  kind: SubqlHandlerKind.Call;\n  filter?: SubqlCallFilter;\n}\n\nexport interface SubqlEventHandler {\n  handler: string;\n  kind: SubqlHandlerKind.Event;\n  filter?: SubqlEventFilter;\n}\n\nexport interface SubqlCustomHandler<K extends string = string, F = Record<string, unknown>> {\n  handler: string;\n  kind: K;\n  filter?: F;\n}\n\nexport type SubqlRuntimeHandler = SubqlBlockHandler | SubqlCallHandler | SubqlEventHandler;\n\nexport type SubqlHandler = SubqlRuntimeHandler | SubqlCustomHandler<string, unknown>;\n\nexport type SubqlHandlerFilter = SubqlBlockFilter | SubqlCallFilter | SubqlEventFilter;\n\nexport interface SubqlMapping<T extends SubqlHandler = SubqlHandler> {\n  handlers: T[];\n}\n\ninterface ISubqlDatasource<M extends SubqlMapping, F extends SubqlNetworkFilter = SubqlNetworkFilter> {\n  name?: string;\n  kind: string;\n  filter?: F;\n  startBlock?: number;\n  mapping: M;\n}\n\nexport interface SubqlRuntimeDatasource<M extends SubqlMapping<SubqlRuntimeHandler> = SubqlMapping<SubqlRuntimeHandler>>\n  extends ISubqlDatasource<M> {\n  kind: SubqlDatasourceKind.Runtime;\n}\n\nexport interface SubqlNetworkFilter {\n  specName?: string;\n}\n\nexport type SubqlDatasource = SubqlRuntimeDatasource | SubqlCustomDatasource; // | SubqlBuiltinDataSource;\n\nexport interface FileReference {\n  file: string;\n}\n\nexport type CustomDataSourceAsset = FileReference;\n\nexport type Processor<O = any> = FileReference & {options?: O};\n\nexport interface SubqlCustomDatasource<\n  K extends string = string,\n  T extends SubqlNetworkFilter = SubqlNetworkFilter,\n  M extends SubqlMapping = SubqlMapping<SubqlCustomHandler>,\n  O = any\n> extends ISubqlDatasource<M, T> {\n  kind: K;\n  assets: Map<string, CustomDataSourceAsset>;\n  processor: Processor<O>;\n}\n\n//export type SubqlBuiltinDataSource = ISubqlDatasource;\n\nexport interface HandlerInputTransformer<\n  T extends SubqlHandlerKind,\n  U,\n  DS extends SubqlCustomDatasource = SubqlCustomDatasource\n> {\n  (original: RuntimeHandlerInputMap[T], ds: DS, api: ApiPromise, assets: Record<string, string>): Promise<U>; //  | SubqlBuiltinDataSource\n}\n\nexport interface SubqlDatasourceProcessor<\n  K extends string,\n  F extends SubqlNetworkFilter,\n  DS extends SubqlCustomDatasource<K, F> = SubqlCustomDatasource<K, F>\n> {\n  kind: K;\n  validate(ds: DS, assets: Record<string, string>): void;\n  dsFilterProcessor(ds: DS, api: ApiPromise): boolean;\n  handlerProcessors: {[kind: string]: SecondLayerHandlerProcessor<SubqlHandlerKind, unknown, unknown, DS>};\n}\n\nexport interface DictionaryQueryCondition {\n  field: string;\n  value: string;\n}\n\nexport interface DictionaryQueryEntry {\n  entity: string;\n  conditions: DictionaryQueryCondition[];\n}\n\n// only allow one custom handler for each baseHandler kind\nexport interface SecondLayerHandlerProcessor<\n  K extends SubqlHandlerKind,\n  F,\n  E,\n  DS extends SubqlCustomDatasource = SubqlCustomDatasource\n> {\n  baseHandlerKind: K;\n  baseFilter: RuntimeFilterMap[K] | RuntimeFilterMap[K][];\n  transformer: HandlerInputTransformer<K, E, DS>;\n  filterProcessor: (filter: F | undefined, input: RuntimeHandlerInputMap[K], ds: DS) => boolean;\n  filterValidator: (filter: F) => void;\n  dictionaryQuery?: (filter: F, ds: DS) => DictionaryQueryEntry;\n}\n"]}