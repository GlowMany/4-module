"use strict";
// Copyright 2020-2021 OnFinality Limited authors & contributors
// SPDX-License-Identifier: Apache-2.0
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RequireCustomDsValidation = void 0;
const path_1 = __importDefault(require("path"));
const common_1 = require("@subql/common");
const rule_1 = require("./rule");
class RequireCustomDsValidation {
    constructor() {
        this.type = rule_1.RuleType.Schema;
        this.name = 'require-custom-ds-validation';
        this.description = 'custom datasources mast pass processor validation';
    }
    validate(ctx) {
        const schema = ctx.data.schema;
        if (schema.isV0_2_0) {
            for (const customDs of schema.dataSources.filter(common_1.isCustomDs)) {
                const processor = require(path_1.default.resolve(ctx.data.projectPath, customDs.processor.file)).default;
                if (customDs.kind !== processor.kind) {
                    ctx.logger.log(`ds kind (${customDs.kind}) doesnt match processor (${processor.kind})`);
                    return false;
                }
                for (const handler of customDs.mapping.handlers) {
                    if (!(handler.kind in processor.handlerProcessors)) {
                        ctx.logger.log(`ds kind ${handler.kind} not one of ${Object.keys(processor.handlerProcessors).join(', ')}`);
                        return false;
                    }
                }
                try {
                    customDs.mapping.handlers.map((handler) => processor.handlerProcessors[handler.kind].filterValidator(handler.filter));
                }
                catch (e) {
                    ctx.logger.log(`Invalid filter for DS: ${e.message}`);
                    return false;
                }
            }
        }
        return true;
    }
}
exports.RequireCustomDsValidation = RequireCustomDsValidation;
//# sourceMappingURL=require-custom-ds-validation.js.map