// Copyright 2017-2021 @polkadot/api-derive authors & contributors
// SPDX-License-Identifier: Apache-2.0
import { catchError, combineLatest, map, of, switchMap } from 'rxjs';
import { isFunction } from '@polkadot/util';
import { firstObservable } from "../util/index.js";
import { callMethod, withSection } from "./helpers.js"; // We are re-exporting these from here to ensure that *.d.ts generation is correct

function parse(api, [hashes, proposals, votes]) {
  return proposals.map((o, index) => o && o.isSome ? {
    hash: api.registry.createType('Hash', hashes[index]),
    proposal: o.unwrap(),
    votes: votes[index].unwrapOr(null)
  } : null).filter(proposal => !!proposal);
}

function _proposalsFrom(section, api, hashes) {
  var _api$query$section;

  return (isFunction((_api$query$section = api.query[section]) === null || _api$query$section === void 0 ? void 0 : _api$query$section.proposals) && hashes.length ? combineLatest([of(hashes), // this should simply be api.query[section].proposalOf.multi<Option<Proposal>>(hashes),
  // however we have had cases on Edgeware where the indices have moved around after an
  // upgrade, which results in invalid on-chain data
  combineLatest(hashes.map(h => api.query[section].proposalOf(h).pipe(catchError(() => of(null))))), api.query[section].voting.multi(hashes)]) : of([[], [], []])).pipe(map(r => parse(api, r)));
}

export function hasProposals(_section) {
  return withSection(_section, (section, api) => () => {
    var _api$query$section2;

    return of(isFunction((_api$query$section2 = api.query[section]) === null || _api$query$section2 === void 0 ? void 0 : _api$query$section2.proposals));
  });
}
export function proposals(_section) {
  return withSection(_section, (section, api) => () => api.derive[section].proposalHashes().pipe(switchMap(all => _proposalsFrom(section, api, all))));
}
export function proposal(_section) {
  return withSection(_section, (section, api) => hash => {
    var _api$query$section3;

    return isFunction((_api$query$section3 = api.query[section]) === null || _api$query$section3 === void 0 ? void 0 : _api$query$section3.proposals) ? firstObservable(_proposalsFrom(section, api, [hash])) : of(null);
  });
}
export const proposalCount = callMethod('proposalCount', null);
export const proposalHashes = callMethod('proposals', []);